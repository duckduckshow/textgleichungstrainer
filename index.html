<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gleichungen Schritt f√ºr Schritt (Summe + Differenz)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#8ea0d6; --text:#eef2ff;
      --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; --line:#243055;
      --btn:#1f2a52; --btn2:#182044;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:linear-gradient(180deg,#070a14 0%, #0b1020 40%, #070a14 100%);
      color:var(--text);
      min-height:100vh;
      display:flex; align-items:flex-start; justify-content:center;
      padding:24px;
    }
    .wrap{width:min(980px,100%); display:grid; gap:16px}
    .top{display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;}
    .title{display:flex; flex-direction:column; gap:4px;}
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}
    .card{
      background:rgba(18,26,51,.92);
      border:1px solid rgba(36,48,85,.9);
      border-radius:16px;
      padding:16px;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
    }
    .grid{display:grid; gap:16px; grid-template-columns: 1.1fr .9fr;}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      font-size:12px; color:var(--muted); background:rgba(7,10,20,.35);
    }
    .progress{
      height:10px; background:rgba(7,10,20,.55);
      border:1px solid var(--line); border-radius:999px; overflow:hidden;
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg, rgba(34,197,94,.95), rgba(34,197,94,.55)); transition:width .25s ease;}
    label{font-size:13px; color:var(--muted)}
    input[type="text"], input[type="number"], select{
      width:100%;
      padding:10px 12px;
      background:rgba(7,10,20,.55);
      border:1px solid var(--line);
      border-radius:12px;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{border-color:rgba(142,160,214,.9)}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:600;
      transition:transform .05s ease, background .15s ease;
    }
    .btn:active{transform:scale(.99)}
    .btn.secondary{background:var(--btn2); font-weight:600}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .stepTitle{font-size:15px; margin:0 0 6px 0}
    .hint{
      background:rgba(245,158,11,.12);
      border:1px solid rgba(245,158,11,.35);
      color:#ffe8b3;
      padding:10px 12px; border-radius:12px;
      font-size:13px;
      white-space:pre-line;
    }
    .feedback{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(7,10,20,.45);
      font-size:13px;
      line-height:1.35;
      white-space:pre-line;
    }
    .feedback.good{border-color:rgba(34,197,94,.5); background:rgba(34,197,94,.10)}
    .feedback.bad{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.10)}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{font-size:12px; color:var(--muted)}
    .divider{height:1px; background:rgba(36,48,85,.8); margin:12px 0}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 560px){ .two{grid-template-columns:1fr} }
    .radioRow{display:flex; gap:10px; flex-wrap:wrap}
    .radio{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(7,10,20,.35);
      cursor:pointer;
      user-select:none;
    }
    .radio input{transform:translateY(1px)}
    .footerNote{font-size:12px; color:var(--muted); line-height:1.35}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Gleichungen Schritt f√ºr Schritt</h1>
        <div class="sub">Summe + ‚Äûum ‚Ä¶ mehr/weniger‚Äú ‚Äî jeder Schritt wird gepr√ºft.</div>
      </div>
      <div class="row">
        <span class="pill" id="pillProblem">Problem: ‚Äî</span>
        <span class="pill" id="pillStep">Schritt: ‚Äî</span>
      </div>
    </div>

    <div class="card">
      <div class="progress" aria-label="Fortschritt">
        <div class="bar" id="progressBar"></div>
      </div>
      <div class="small" id="progressText" style="margin-top:8px;">0 / 5 erledigt</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-start; gap:12px;">
          <div style="flex:1">
            <label for="problemSelect">Aufgabe w√§hlen</label>
            <select id="problemSelect"></select>
          </div>
          <div class="row" style="margin-top:22px;">
            <button class="btn secondary" id="btnNew">Neu starten</button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="problemText" class="feedback" style="margin-bottom:12px;"></div>

        <section id="step1">
          <h2 class="stepTitle">Schritt 1: Allgemeine Summe aufschreiben</h2>
          <div class="small">Schreibe die Summe als Gleichung, z.B. <span class="mono">Sandra + Hannes = 30</span></div>
          <div style="margin-top:10px;">
            <label for="inpSumEq">Deine Gleichung</label>
            <input id="inpSumEq" type="text" placeholder="z.B. A + B = 30" autocomplete="off" />
          </div>
          <div class="row" style="margin-top:12px;">
            <button class="btn" id="check1">Pr√ºfen</button>
            <button class="btn secondary" id="hint1">Hinweis</button>
          </div>
          <div id="fb1" class="feedback" style="margin-top:12px; display:none;"></div>
          <div id="h1" class="hint" style="margin-top:12px; display:none;"></div>
        </section>

        <section id="step2" style="display:none;">
          <h2 class="stepTitle">Schritt 2: Lege fest, was <span class="mono">x</span> bedeutet</h2>
          <div class="small">W√§hle eine Gr√∂√üe als <span class="mono">x</span>. Dann gib die andere Gr√∂√üe als <span class="mono">x ¬± Zahl</span> an.</div>

          <div class="divider"></div>

          <div class="radioRow" id="xChoice"></div>

          <div style="margin-top:10px;">
            <label id="lblOtherExpr" for="inpOtherExpr">Andere Gr√∂√üe als Ausdruck in x</label>
            <input id="inpOtherExpr" type="text" placeholder="z.B. x + 6" autocomplete="off" />
            <div class="small" style="margin-top:6px;">
              Erlaubt (simpel): <span class="mono">x</span>, <span class="mono">x+6</span>, <span class="mono">x-3</span>, <span class="mono">6+x</span>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="check2">Pr√ºfen</button>
            <button class="btn secondary" id="hint2">Hinweis</button>
          </div>
          <div id="fb2" class="feedback" style="margin-top:12px; display:none;"></div>
          <div id="h2" class="hint" style="margin-top:12px; display:none;"></div>
        </section>

        <section id="step3" style="display:none;">
          <h2 class="stepTitle">Schritt 3: Einsetzen und Gleichung in <span class="mono">x</span> aufstellen</h2>
          <div class="small">Setze deine Ausdr√ºcke in die Summe ein, z.B. <span class="mono">x + (x+6) = 30</span></div>

          <div style="margin-top:10px;">
            <label for="inpXEq">Deine Gleichung in x</label>
            <input id="inpXEq" type="text" placeholder="z.B. x + (x+6) = 30" autocomplete="off" />
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="check3">Pr√ºfen</button>
            <button class="btn secondary" id="hint3">Hinweis</button>
          </div>
          <div id="fb3" class="feedback" style="margin-top:12px; display:none;"></div>
          <div id="h3" class="hint" style="margin-top:12px; display:none;"></div>
        </section>

        <section id="step4" style="display:none;">
          <h2 class="stepTitle">Schritt 4: L√∂se nach <span class="mono">x</span></h2>
          <div class="small">Gib den Wert f√ºr <span class="mono">x</span> ein (nur Zahl).</div>

          <div style="margin-top:10px;">
            <label for="inpXVal">x =</label>
            <input id="inpXVal" type="number" step="1" placeholder="z.B. 12" />
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="check4">Pr√ºfen</button>
            <button class="btn secondary" id="hint4">Hinweis</button>
          </div>
          <div id="fb4" class="feedback" style="margin-top:12px; display:none;"></div>
          <div id="h4" class="hint" style="margin-top:12px; display:none;"></div>
        </section>

        <section id="step5" style="display:none;">
          <h2 class="stepTitle">Schritt 5: Werte f√ºr beide Gr√∂√üen angeben</h2>
          <div class="small">Trage die beiden Ergebnisse ein.</div>

          <div class="two" style="margin-top:10px;">
            <div>
              <label id="lblA" for="inpAVal">A</label>
              <input id="inpAVal" type="number" step="1" placeholder="Zahl" />
            </div>
            <div>
              <label id="lblB" for="inpBVal">B</label>
              <input id="inpBVal" type="number" step="1" placeholder="Zahl" />
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="check5">Pr√ºfen</button>
            <button class="btn secondary" id="hint5">Hinweis</button>
          </div>
          <div id="fb5" class="feedback" style="margin-top:12px; display:none;"></div>
          <div id="h5" class="hint" style="margin-top:12px; display:none;"></div>
        </section>

        <div class="divider"></div>

        <div class="footerNote">
          Tipp: Dieses Tool pr√ºft ‚Äûgleichwertige‚Äú Eingaben (z.B. <span class="mono">x+(x+6)=30</span> ist okay).
          Es ist absichtlich simpel gehalten (nur lineare Ausdr√ºcke mit <span class="mono">x</span>).
        </div>

        <div class="divider"></div>
        <div id="debugBox" class="feedback" style="display:none;"></div>
      </div>

      <div class="card">
        <h2 class="stepTitle">Lehrkraft-Ansicht (automatisch)</h2>
        <div class="small">Zeigt die erwarteten Ausdr√ºcke/L√∂sung (nach Schritt 2).</div>
        <div class="divider"></div>
        <div class="feedback" id="teacherBox"><span class="small">W√§hle eine Aufgabe und starte.</span></div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Falls irgendwo ein Fehler passiert: im Debug-Feld anzeigen (hilft auf GitHub extrem)
  const debugBox = document.getElementById("debugBox");
  window.addEventListener("error", (e) => {
    debugBox.style.display = "block";
    debugBox.className = "feedback bad";
    debugBox.textContent =
      "JS-Fehler:\n" + (e.message || "Unbekannt") +
      "\n\nDatei: " + (e.filename || "?") +
      "\nZeile: " + (e.lineno || "?");
  });

  const TASKS = [
    { id:"sandra-hannes", title:"Sandra & Hannes (Alter)",
      text:"Sandra ist um 6 Jahre j√ºnger als ihr Bruder Hannes. Die beiden sind zusammen 30 Jahre alt.",
      A:"Sandra", B:"Hannes", sum:30, diff:-6, unit:"Jahre" },
    { id:"stefan-thomas", title:"Stefan & Thomas (Taschengeld)",
      text:"Stefan und Thomas bekommen zusammen 21 ‚Ç¨ Taschengeld. Thomas bekommt um 3 ‚Ç¨ weniger als Stefan.",
      A:"Thomas", B:"Stefan", sum:21, diff:-3, unit:"‚Ç¨" },
    { id:"verena-wellensittiche", title:"Wellensittiche (blau/gr√ºn)",
      text:"Verena z√ºchtet Wellensittiche. Sie hat 49 V√∂gel, die entweder gr√ºnes oder blaues Gefieder haben. Es sind um 7 blaue V√∂gel mehr als gr√ºne.",
      A:"Blau", B:"Gr√ºn", sum:49, diff:+7, unit:"V√∂gel" },
    { id:"hanni-nanni", title:"Hanni & Nanni (Taschengeld)",
      text:"Hanni bekommt um 7 ‚Ç¨ mehr Taschengeld als Nanni. Zusammen erhalten sie 29 ‚Ç¨.",
      A:"Hanni", B:"Nanni", sum:29, diff:+7, unit:"‚Ç¨" },
  ];

  // DOM
  const problemSelect = document.getElementById("problemSelect");
  const problemText = document.getElementById("problemText");
  const pillProblem = document.getElementById("pillProblem");
  const pillStep = document.getElementById("pillStep");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");
  const teacherBox = document.getElementById("teacherBox");

  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const step3 = document.getElementById("step3");
  const step4 = document.getElementById("step4");
  const step5 = document.getElementById("step5");

  const inpSumEq = document.getElementById("inpSumEq");
  const inpOtherExpr = document.getElementById("inpOtherExpr");
  const inpXEq = document.getElementById("inpXEq");
  const inpXVal = document.getElementById("inpXVal");
  const inpAVal = document.getElementById("inpAVal");
  const inpBVal = document.getElementById("inpBVal");

  const lblA = document.getElementById("lblA");
  const lblB = document.getElementById("lblB");
  const xChoice = document.getElementById("xChoice");
  const lblOtherExpr = document.getElementById("lblOtherExpr");

  const fb1 = document.getElementById("fb1");
  const fb2 = document.getElementById("fb2");
  const fb3 = document.getElementById("fb3");
  const fb4 = document.getElementById("fb4");
  const fb5 = document.getElementById("fb5");

  const h1 = document.getElementById("h1");
  const h2 = document.getElementById("h2");
  const h3 = document.getElementById("h3");
  const h4 = document.getElementById("h4");
  const h5 = document.getElementById("h5");

  // Zustand
  let task = TASKS[0];
  let done = [false,false,false,false,false];
  let xIs = "A";
  let exprA = null, exprB = null;

  // UI helpers
  function setFeedback(el, kind, text){
    el.style.display = "block";
    el.className = "feedback " + (kind || "");
    el.textContent = text;
  }
  function hideFeedback(el){ el.style.display="none"; el.textContent=""; el.className="feedback"; }
  function toggleHint(n){
    const map = {1:h1,2:h2,3:h3,4:h4,5:h5};
    const el = map[n];
    el.style.display = (el.style.display === "none" ? "block" : "none");
  }

  function updatePills(){
    pillProblem.textContent = "Problem: " + task.title;
    const stepNum = currentStepIndex()+1;
    pillStep.textContent = "Schritt: " + stepNum + " / 5";
  }
  function updateProgress(){
    const count = done.filter(Boolean).length;
    progressText.textContent = count + " / 5 erledigt";
    progressBar.style.width = (count/5*100) + "%";
  }
  function currentStepIndex(){
    for(let i=0;i<done.length;i++) if(!done[i]) return i;
    return 4;
  }

  function showSteps(){
    step1.style.display = done[0] ? "none" : "block";
    step2.style.display = (done[0] && !done[1]) ? "block" : "none";
    step3.style.display = (done[0] && done[1] && !done[2]) ? "block" : "none";
    step4.style.display = (done[0] && done[1] && done[2] && !done[3]) ? "block" : "none";
    step5.style.display = (done[0] && done[1] && done[2] && done[3]) ? "block" : "none";
    updatePills();
    updateProgress();
    updateTeacherBox();
  }

  // Parsing/math (gleich wie zuvor, nur kompakt √ºbernommen)
  function normalize(s){ return (s||"").toLowerCase().replace(/\s+/g,"").replace(/,/g,"."); }
  function isBalanced(s){ let d=0; for(const ch of s){ if(ch==="(") d++; if(ch===")") d--; if(d<0) return false; } return d===0; }
  function parseLinear(expr){
    let s = normalize(expr);
    while(s.startsWith("(") && s.endsWith(")")){
      const inner=s.slice(1,-1);
      if(isBalanced(inner)) s=inner; else break;
    }
    if(s.includes("*")||s.includes("/")||s.includes("^")) return null;
    if(s.startsWith("+")) s=s.slice(1);

    const isNumber = (t)=>/^[-+]?\d+(\.\d+)?$/.test(t);
    const isX = (t)=> t==="x" || t==="+x" || t==="-x";

    const parts=[]; let cur="";
    for(let i=0;i<s.length;i++){
      const ch=s[i];
      if((ch==="+"||ch==="-" ) && i>0){ parts.push(cur); cur=ch; }
      else cur+=ch;
    }
    if(cur) parts.push(cur);

    let a=0,b=0;
    for(const p of parts){
      if(p==="") continue;
      if(isX(p)){ a += (p.startsWith("-") ? -1 : 1); continue; }
      if(p.endsWith("x") && isNumber(p.slice(0,-1))){ a += Number(p.slice(0,-1)); continue; }
      if(isNumber(p)){ b += Number(p); continue; }
      return null;
    }
    return {a,b};
  }
  function nearlyEqual(x,y){ return Math.abs(x-y) < 1e-9; }
  function exprToString(e){
    if(!e) return "?";
    const a=e.a,b=e.b;
    if(a===0) return String(b);
    let out = (a===1)?"x":(a===-1)?"-x":(a+"x");
    if(b>0) out += "+"+b;
    if(b<0) out += b;
    return out;
  }
  function aliasOf(nameNorm){ return nameNorm.length?nameNorm[0]:nameNorm; }
  function parseSumEquation(eq){
    const s=normalize(eq);
    if(!s.includes("=")) return null;
    const [L,R]=s.split("=");
    if(!L||!R) return null;
    if(!/^\d+(\.\d+)?$/.test(R)) return null;
    const idx=L.indexOf("+"); if(idx<0) return null;
    const left1=L.slice(0,idx), left2=L.slice(idx+1);
    if(!left1||!left2) return null;

    const a=normalize(task.A), b=normalize(task.B);
    const names=[left1,left2];
    const ok = (
      (names.includes(a)&&names.includes(b)) ||
      (names.includes(aliasOf(a))&&names.includes(b)) ||
      (names.includes(a)&&names.includes(aliasOf(b))) ||
      (names.includes(aliasOf(a))&&names.includes(aliasOf(b)))
    );
    const okAB = names.includes("a") && names.includes("b");
    if(!ok && !okAB) return null;
    return {sum:Number(R)};
  }
  function parseLinearEquation(eq){
    const s=normalize(eq);
    if(!s.includes("=")) return null;
    let [L,R]=s.split("=");
    if(!L||!R) return null;
    const clean = (side)=>{
      let t=side.replace(/[()]/g,"");
      t=t.replace(/--/g,"+").replace(/\+-/g,"-").replace(/-\+/g,"-");
      return t;
    };
    const LL=parseLinear(clean(L));
    const RR=parseLinear(clean(R));
    if(!LL||!RR) return null;
    return {L:LL,R:RR};
  }
  function equivalentLinearEq(eq1, eq2){
    const d1={a:eq1.L.a-eq1.R.a, b:eq1.L.b-eq1.R.b};
    const d2={a:eq2.L.a-eq2.R.a, b:eq2.L.b-eq2.R.b};
    return nearlyEqual(d1.a,d2.a) && nearlyEqual(d1.b,d2.b);
  }
  function buildExpectedFromChoice(){
    if(xIs==="A"){ exprA={a:1,b:0}; exprB={a:1,b:-task.diff}; }
    else { exprB={a:1,b:0}; exprA={a:1,b:task.diff}; }
  }
  function solveForX(eA,eB,sum){
    const a=eA.a+eB.a, b=eA.b+eB.b;
    const x=(sum-b)/a;
    return {x, A:eA.a*x+eA.b, B:eB.a*x+eB.b};
  }

  function updateTeacherBox(){
    let txt="Erwartung:\n\n";
    txt += "Summe: " + task.A + " + " + task.B + " = " + task.sum + "\n";
    if(!(done[1]||done[2]||done[3]||done[4])){
      txt += "\n(Wird genauer nach Schritt 2)";
      teacherBox.textContent=txt;
      return;
    }
    txt += "\n" + task.A + " = " + exprToString(exprA) + "\n";
    txt += task.B + " = " + exprToString(exprB) + "\n";
    const sol=solveForX(exprA,exprB,task.sum);
    txt += "\nL√∂sung: x = " + sol.x + "\n";
    txt += task.A + " = " + sol.A + " " + task.unit + "\n";
    txt += task.B + " = " + sol.B + " " + task.unit + "\n";
    teacherBox.textContent=txt;
  }

  function refreshHints(){
    h1.textContent = "Summe aus dem Text als Gleichung:\n" + task.A + " + " + task.B + " = " + task.sum;
    h2.textContent = "Wenn x eine Gr√∂√üe ist, schreibe die andere als x ¬± Differenz.\nHier gilt: " +
      task.A + " = " + task.B + (task.diff>=0 ? " + " + task.diff : " - " + Math.abs(task.diff));
    h3.textContent = "Ersetze die Namen aus Schritt 1 durch deine x-Ausdr√ºcke:\n(" + exprToString(exprA||{a:1,b:0}) + ") + (" + exprToString(exprB||{a:1,b:0}) + ") = " + task.sum;
    h4.textContent = "Bringe alles zusammen: meistens entsteht 2x + Zahl = " + task.sum + "\nDann nach x l√∂sen.";
    h5.textContent = "Setze x in beide Ausdr√ºcke ein:\n" + task.A + " = " + exprToString(exprA||null) + "\n" + task.B + " = " + exprToString(exprB||null);
  }

  // Step checks
  function checkStep1(){
    hideFeedback(fb1); h1.style.display="none";
    const parsed=parseSumEquation(inpSumEq.value);
    if(!parsed) return setFeedback(fb1,"bad","Form passt nicht. Beispiel:\n" + task.A + " + " + task.B + " = " + task.sum);
    if(!nearlyEqual(parsed.sum, task.sum)) return setFeedback(fb1,"bad","Summe stimmt nicht. In der Aufgabe: " + task.sum);
    done[0]=true; setFeedback(fb1,"good","‚úÖ Schritt 1 korrekt!"); showSteps();
  }
  function checkStep2(){
    hideFeedback(fb2); h2.style.display="none";
    const sel=document.querySelector('input[name="xIs"]:checked');
    if(!sel) return setFeedback(fb2,"bad","Bitte w√§hlen: Was ist x?");
    xIs=sel.value; buildExpectedFromChoice();

    const parsed=parseLinear(inpOtherExpr.value);
    if(!parsed) return setFeedback(fb2,"bad","Das ist kein einfacher Ausdruck in x (z.B. x+6).");
    const expectedOther=(xIs==="A")?exprB:exprA;
    if(!(nearlyEqual(parsed.a, expectedOther.a) && nearlyEqual(parsed.b, expectedOther.b))){
      return setFeedback(fb2,"bad","Noch nicht passend.\nErwartet z.B.: " + exprToString(expectedOther));
    }
    done[1]=true; setFeedback(fb2,"good","‚úÖ Schritt 2 korrekt!"); showSteps();
  }
  function checkStep3(){
    hideFeedback(fb3); h3.style.display="none";
    if(!exprA||!exprB) return setFeedback(fb3,"bad","Bitte zuerst Schritt 2 abschlie√üen.");
    const eq=parseLinearEquation(inpXEq.value);
    if(!eq) return setFeedback(fb3,"bad","Das ist keine pr√ºfbare Gleichung in x. Beispiel:\n" + exprToString(exprA) + " + (" + exprToString(exprB) + ") = " + task.sum);
    const expected={L:{a:exprA.a+exprB.a, b:exprA.b+exprB.b}, R:{a:0,b:task.sum}};
    if(!equivalentLinearEq(eq, expected)){
      return setFeedback(fb3,"bad","Einsetzen stimmt noch nicht.\nEine korrekte Form ist z.B.:\n(" + exprToString(exprA) + ") + (" + exprToString(exprB) + ") = " + task.sum);
    }
    done[2]=true; setFeedback(fb3,"good","‚úÖ Schritt 3 korrekt!"); showSteps();
  }
  function checkStep4(){
    hideFeedback(fb4); h4.style.display="none";
    if(!exprA||!exprB) return setFeedback(fb4,"bad","Bitte zuerst Schritt 2 abschlie√üen.");
    const val=Number(inpXVal.value);
    if(!Number.isFinite(val)) return setFeedback(fb4,"bad","Bitte Zahl f√ºr x eingeben.");
    const sol=solveForX(exprA,exprB,task.sum);
    if(!nearlyEqual(val, sol.x)) return setFeedback(fb4,"bad","x stimmt noch nicht.");
    done[3]=true; setFeedback(fb4,"good","‚úÖ Schritt 4 korrekt! x = " + sol.x); showSteps();
  }
  function checkStep5(){
    hideFeedback(fb5); h5.style.display="none";
    if(!exprA||!exprB) return setFeedback(fb5,"bad","Bitte zuerst Schritt 2 abschlie√üen.");
    const aVal=Number(inpAVal.value), bVal=Number(inpBVal.value);
    if(!Number.isFinite(aVal)||!Number.isFinite(bVal)) return setFeedback(fb5,"bad","Bitte beide Zahlen eintragen.");
    const sol=solveForX(exprA,exprB,task.sum);
    if(!(nearlyEqual(aVal, sol.A)&&nearlyEqual(bVal, sol.B))) return setFeedback(fb5,"bad","Werte passen noch nicht (evtl. vertauscht?).");
    done[4]=true;
    setFeedback(fb5,"good","üéâ Alles korrekt!\n" + task.A + " = " + sol.A + " " + task.unit + "\n" + task.B + " = " + sol.B + " " + task.unit);
    showSteps();
  }

  // Buttons / hints
  document.getElementById("check1").addEventListener("click", checkStep1);
  document.getElementById("check2").addEventListener("click", checkStep2);
  document.getElementById("check3").addEventListener("click", checkStep3);
  document.getElementById("check4").addEventListener("click", checkStep4);
  document.getElementById("check5").addEventListener("click", checkStep5);

  document.getElementById("hint1").addEventListener("click", ()=>toggleHint(1));
  document.getElementById("hint2").addEventListener("click", ()=>toggleHint(2));
  document.getElementById("hint3").addEventListener("click", ()=>toggleHint(3));
  document.getElementById("hint4").addEventListener("click", ()=>toggleHint(4));
  document.getElementById("hint5").addEventListener("click", ()=>toggleHint(5));

  document.getElementById("btnNew").addEventListener("click", resetAll);

  // Task dropdown
  function populateTasks(){
    problemSelect.innerHTML = "";
    TASKS.forEach(t=>{
      const opt=document.createElement("option");
      opt.value=t.id; opt.textContent=t.title;
      problemSelect.appendChild(opt);
    });
  }

  function renderTask(){
    problemText.textContent = task.text + "\n\nGesucht: " + task.A + " und " + task.B + ".";
    lblA.textContent = task.A + " (" + task.unit + ")";
    lblB.textContent = task.B + " (" + task.unit + ")";

    inpSumEq.value=""; inpOtherExpr.value=""; inpXEq.value=""; inpXVal.value=""; inpAVal.value=""; inpBVal.value="";

    xChoice.innerHTML="";
    const makeRadio=(value,label)=>{
      const wrap=document.createElement("label");
      wrap.className="radio";
      const input=document.createElement("input");
      input.type="radio"; input.name="xIs"; input.value=value;
      const span=document.createElement("span"); span.textContent=label;
      wrap.appendChild(input); wrap.appendChild(span);
      wrap.addEventListener("click", ()=>{
        input.checked=true;
        const other=(value==="A")?task.B:task.A;
        lblOtherExpr.textContent = other + " als Ausdruck in x";
      });
      return wrap;
    };
    xChoice.appendChild(makeRadio("A","x = " + task.A));
    xChoice.appendChild(makeRadio("B","x = " + task.B));
    lblOtherExpr.textContent="Andere Gr√∂√üe als Ausdruck in x";

    [fb1,fb2,fb3,fb4,fb5].forEach(hideFeedback);
    [h1,h2,h3,h4,h5].forEach(el=>{el.style.display="none"; el.textContent="";});
    refreshHints();
    updatePills();
    updateTeacherBox();
  }

  function resetAll(){
    done=[false,false,false,false,false];
    xIs="A"; exprA=null; exprB=null;
    renderTask();
    showSteps();
  }

  problemSelect.addEventListener("change", ()=>{
    task = TASKS.find(t=>t.id===problemSelect.value) || TASKS[0];
    resetAll();
  });

  // INIT (entscheidend!)
  populateTasks();
  problemSelect.value = TASKS[0].id;
  task = TASKS[0];
  resetAll();
});
</script>
</body>
</html>
